# Story 1.4: Gemini API Integration and Authentication

Status: ready-for-dev

## Story

As a **data mining student**,
I want **secure integration with Google Gemini Embedding API**,
So that **I can generate semantic embeddings for clustering**.

## Acceptance Criteria

### AC-1: Gemini API Authentication Successful
**Given** Valid API key in `.env`
**When** I call `EmbeddingService(api_key).test_connection()`
**Then**:
- ‚úÖ Returns `True` (authentication successful)
- ‚úÖ Test embedding generated for "Hello world"
- ‚úÖ Embedding shape is (768,)
- ‚úÖ Embedding dtype is float32
- ‚úÖ Logs: "‚úÖ API authentication successful"

### AC-2: Gemini API Error Handling
**Given** Invalid or missing API key
**When** I call `EmbeddingService(api_key).test_connection()`
**Then**:
- ‚úÖ Raises `AuthenticationError` with helpful message
- ‚úÖ Error message includes: "GEMINI_API_KEY not found" or "Invalid API key"
- ‚úÖ Error message includes next steps: "Copy .env.example to .env and add your API key"
- ‚úÖ API key value never exposed in logs or error messages

### AC-3: Retry Logic Functional
**Given** Network error occurs during API call
**When** Retry logic activates
**Then**:
- ‚úÖ Up to 3 retry attempts made
- ‚úÖ Exponential backoff used: 4s, 8s, 16s (approximately)
- ‚úÖ Each retry attempt logged: "‚ö†Ô∏è API call failed, retrying (attempt X/3)..."
- ‚úÖ Success on retry logged: "‚úÖ API call successful after X attempts"
- ‚úÖ Failure after 3 attempts raises exception with context

### AC-4: Embedding Cache Functional
**Given** Embeddings generated
**When** I call `EmbeddingCache().save(embeddings, "train", metadata)`
**Then**:
- ‚úÖ Embeddings saved to `data/embeddings/train_embeddings.npy`
- ‚úÖ Metadata saved to `data/embeddings/train_metadata.json`
- ‚úÖ Saved embeddings are float32 dtype
- ‚úÖ Metadata includes: model, dimensions, num_documents, timestamp, dataset, split, api_calls, estimated_cost

**And when** I call `EmbeddingCache().load("train")`
**Then**:
- ‚úÖ Returns tuple of (embeddings, metadata)
- ‚úÖ Loaded embeddings match original (np.allclose check)
- ‚úÖ Loaded metadata matches saved metadata

## Tasks / Subtasks

- [ ] Implement EmbeddingService class in src/context_aware_multi_agent_system/features/embedding_service.py (AC: #1, #2, #3)
  - [ ] Import required libraries: `from google import genai`, typing, numpy, tenacity
  - [ ] Implement __init__ method:
    - [ ] Accept api_key and model parameters
    - [ ] Initialize genai.Client with API key
    - [ ] Store model name (default: "gemini-embedding-001")
    - [ ] Validate API key is not None or empty
  - [ ] Implement test_connection() method:
    - [ ] Generate test embedding for "Hello world"
    - [ ] Validate embedding shape (768,) and dtype (float32)
    - [ ] Return True on success
    - [ ] Raise AuthenticationError on failure with helpful message
    - [ ] Log success: "‚úÖ API authentication successful"
  - [ ] Implement generate_embedding(text: str) method with retry decorator:
    - [ ] Use @retry decorator (max 3 attempts, exponential backoff 4-10s)
    - [ ] Call client.models.embed_content() with model and text
    - [ ] Extract embedding from response
    - [ ] Convert to numpy array with dtype=float32
    - [ ] Validate embedding shape (768,)
    - [ ] Log retry attempts and success
    - [ ] Return embedding array
  - [ ] Implement generate_batch(documents: List[str], batch_size: int) method with retry:
    - [ ] Use @retry decorator
    - [ ] Split documents into batches of batch_size (default: 100)
    - [ ] Call client.models.embed_content() for each batch
    - [ ] Log progress: "Processing batch X/Y"
    - [ ] Concatenate batch results into single array
    - [ ] Validate final shape (n_documents, 768)
    - [ ] Return embeddings array (float32)
  - [ ] Add type hints for all methods
  - [ ] Add docstrings with usage examples (Google style)

- [ ] Implement EmbeddingCache class in src/context_aware_multi_agent_system/features/embedding_cache.py (AC: #4)
  - [ ] Import required libraries: numpy, json, pathlib, typing, datetime
  - [ ] Implement __init__ method:
    - [ ] Accept cache_dir parameter (Path)
    - [ ] Create cache directory if not exists
    - [ ] Store cache_dir path
  - [ ] Implement save(embeddings, split, metadata) method:
    - [ ] Validate embeddings dtype is float32
    - [ ] Construct file paths: {split}_embeddings.npy, {split}_metadata.json
    - [ ] Save embeddings as .npy file
    - [ ] Add timestamp to metadata if not present
    - [ ] Save metadata as JSON with indent=2
    - [ ] Log save operation: "üíæ Saved embeddings to {path}"
    - [ ] Return saved file path
  - [ ] Implement load(split) method:
    - [ ] Construct file paths for embeddings and metadata
    - [ ] Check if files exist, raise CacheNotFoundError if missing
    - [ ] Load embeddings from .npy file
    - [ ] Load metadata from JSON file
    - [ ] Validate embeddings dtype is float32
    - [ ] Log load operation: "‚úÖ Loaded embeddings from {path}"
    - [ ] Return tuple of (embeddings, metadata)
  - [ ] Implement exists(split) method:
    - [ ] Check if both .npy and .json files exist
    - [ ] Return boolean
  - [ ] Implement clear(split) method:
    - [ ] Delete .npy and .json files for given split
    - [ ] Log clear operation
    - [ ] Handle FileNotFoundError gracefully
  - [ ] Add type hints for all methods
  - [ ] Add docstrings with usage examples

- [ ] Create custom exception classes (AC: #2)
  - [ ] Define AuthenticationError in src/context_aware_multi_agent_system/features/embedding_service.py
    - [ ] Inherit from Exception
    - [ ] Accept message parameter with error details
    - [ ] Include troubleshooting guidance in default message
  - [ ] Define CacheNotFoundError in src/context_aware_multi_agent_system/features/embedding_cache.py
    - [ ] Inherit from FileNotFoundError
    - [ ] Accept split name parameter
    - [ ] Include helpful message with cache directory path

- [ ] Create .env.example template file (AC: #2)
  - [ ] Create .env.example in project root
  - [ ] Add GEMINI_API_KEY placeholder with instructions
  - [ ] Add comments explaining usage
  - [ ] Ensure .env is in .gitignore

- [ ] Update Config class to provide gemini_api_key property (AC: #1)
  - [ ] Add @property gemini_api_key in src/context_aware_multi_agent_system/config.py
  - [ ] Load from environment variable GEMINI_API_KEY
  - [ ] Raise ValueError if not found with clear message
  - [ ] Never log the actual API key value (mask as ***)

- [ ] Test Gemini API integration workflow (AC: #1, #2, #3, #4)
  - [ ] Test authentication with valid API key
  - [ ] Test authentication failure with missing API key
  - [ ] Test authentication failure with invalid API key
  - [ ] Test single embedding generation
  - [ ] Test batch embedding generation (100 documents)
  - [ ] Test retry logic with mock network failures
  - [ ] Test embedding cache save operation
  - [ ] Test embedding cache load operation
  - [ ] Test cache roundtrip (save then load, verify match)
  - [ ] Test embedding dtype validation (float32)
  - [ ] Test embedding shape validation (768,)

- [ ] Update project documentation (AC: all)
  - [ ] Update README.md with API key setup instructions
  - [ ] Document .env.example ‚Üí .env copy process
  - [ ] Document EmbeddingService usage examples
  - [ ] Document EmbeddingCache usage examples
  - [ ] Document retry logic behavior
  - [ ] Add troubleshooting section for API authentication errors

## Dev Notes

### Architecture Alignment

This story implements **FR-2** (Embedding API Integration) from [PRD.md](../PRD.md) and **AC-9, AC-10, AC-11, AC-12** from [tech-spec-epic-1.md](../tech-spec-epic-1.md#acceptance-criteria-authoritative).

**Gemini API Integration:**
- **SDK**: `google-genai` Python package (latest version, ‚â•0.3.0)
- **Model**: `gemini-embedding-001` (768 dimensions, multilingual)
- **Pricing**: Batch API $0.075/1M tokens (50% savings vs standard $0.15/1M)
- **Authentication**: API key via `GEMINI_API_KEY` environment variable
- **Endpoint**: Google Generative AI API (managed by SDK)

**IMPORTANT API CHANGE:**
- ‚ùå OLD (deprecated): `import google.generativeai as genai`
- ‚úÖ NEW (current): `from google import genai`
- The `google.generativeai` module is no longer supported
- Use `genai.Client(api_key=...)` for API initialization

**Retry Strategy:**
- Uses `tenacity` library for automatic retry with exponential backoff
- Max 3 attempts per API call
- Exponential backoff: 4s, 8s, 16s (min=4, max=10, multiplier=1)
- Retries on network errors and rate limiting
- Logs each retry attempt for debugging

**Caching Strategy:**
- Embeddings saved as `.npy` files (numpy binary format, compact, fast I/O)
- Metadata saved as `.json` files (human-readable, includes provenance)
- Cache directory: `data/embeddings/` (created automatically)
- Prevents redundant API calls (saves cost and time)
- Metadata includes: model, dimensions, num_documents, timestamp, dataset, split, api_calls, estimated_cost

**Security Considerations:**
- API key stored in `.env` file (NOT committed to git)
- `.env.example` template provided for setup guidance
- `.gitignore` includes `.env` to prevent accidental commits
- API key never logged or exposed in error messages
- Config class masks API key as `GEMINI_API_KEY=***` in logs

**Error Handling:**
- `AuthenticationError`: Invalid or missing API key
- `CacheNotFoundError`: Embedding cache files not found
- Network errors: Automatic retry with exponential backoff
- Validation errors: Shape mismatch, dtype mismatch

**Technology Stack:**
- **google-genai** (‚â•0.3.0): Gemini API SDK
- **numpy** (‚â•1.24): Embedding array storage and operations
- **tenacity** (‚â•8.0): Retry decorator for resilience
- **python-dotenv** (‚â•1.0): Environment variable management
- Follows logging patterns established in Story 1.2

### Testing Standards

**API Authentication Tests:**
```python
# Test valid authentication
service = EmbeddingService(config.gemini_api_key)
assert service.test_connection() == True

# Test missing API key
with pytest.raises(ValueError, match="GEMINI_API_KEY not found"):
    config = Config()  # with no .env file
    api_key = config.gemini_api_key

# Test invalid API key
service = EmbeddingService("invalid-key-12345")
with pytest.raises(AuthenticationError, match="Invalid API key"):
    service.test_connection()
```

**Embedding Generation Tests:**
```python
# Test single embedding
embedding = service.generate_embedding("Hello world")
assert embedding.shape == (768,)
assert embedding.dtype == np.float32

# Test batch embedding
documents = ["doc1", "doc2", "doc3"]
embeddings = service.generate_batch(documents, batch_size=2)
assert embeddings.shape == (3, 768)
assert embeddings.dtype == np.float32
```

**Retry Logic Tests:**
```python
# Test retry on network failure (mock API)
with patch('genai.Client.models.embed_content') as mock_api:
    mock_api.side_effect = [
        NetworkError("Connection timeout"),
        NetworkError("Connection timeout"),
        {"embedding": [0.1] * 768}  # Success on 3rd attempt
    ]

    embedding = service.generate_embedding("test")
    assert embedding.shape == (768,)
    assert mock_api.call_count == 3  # Retried 2 times, succeeded on 3rd
```

**Cache Tests:**
```python
# Test save and load roundtrip
cache = EmbeddingCache(paths.data_embeddings)
embeddings_original = np.random.rand(100, 768).astype(np.float32)
metadata = {
    "model": "gemini-embedding-001",
    "dimensions": 768,
    "num_documents": 100
}

cache.save(embeddings_original, "test", metadata)
embeddings_loaded, metadata_loaded = cache.load("test")

assert np.allclose(embeddings_original, embeddings_loaded)
assert metadata_loaded["model"] == "gemini-embedding-001"
assert metadata_loaded["dimensions"] == 768
```

**Expected Test Coverage:**
- API authentication: valid key, missing key, invalid key
- Embedding generation: single, batch, shape validation, dtype validation
- Retry logic: network failures, exponential backoff, max attempts
- Cache operations: save, load, exists, clear, roundtrip
- Error handling: AuthenticationError, CacheNotFoundError, validation errors

### Project Structure Notes

After completion, the following files will be created/modified:

**New Files:**
- `src/context_aware_multi_agent_system/features/__init__.py` - Features module initialization
- `src/context_aware_multi_agent_system/features/embedding_service.py` - EmbeddingService class and AuthenticationError
- `src/context_aware_multi_agent_system/features/embedding_cache.py` - EmbeddingCache class and CacheNotFoundError
- `.env.example` - Environment variable template (committed)
- `tests/epic1/test_embedding_service.py` - EmbeddingService tests
- `tests/epic1/test_embedding_cache.py` - EmbeddingCache tests

**Modified Files:**
- `src/context_aware_multi_agent_system/config.py` - Add gemini_api_key property
- `.gitignore` - Ensure .env is included (verify)
- `README.md` - Add API key setup instructions

**Expected Directory Structure:**
```
context-aware-multi-agent-system/
‚îú‚îÄ‚îÄ .env                           # API keys (NOT committed) - user creates
‚îú‚îÄ‚îÄ .env.example                   # API key template (committed) - NEW
‚îú‚îÄ‚îÄ data/
‚îÇ   ‚îî‚îÄ‚îÄ embeddings/                # Embedding cache directory
‚îÇ       ‚îú‚îÄ‚îÄ train_embeddings.npy   # Future: created in Epic 2
‚îÇ       ‚îú‚îÄ‚îÄ train_metadata.json    # Future: created in Epic 2
‚îÇ       ‚îú‚îÄ‚îÄ test_embeddings.npy    # Future: created in Epic 2
‚îÇ       ‚îî‚îÄ‚îÄ test_metadata.json     # Future: created in Epic 2
‚îú‚îÄ‚îÄ src/context_aware_multi_agent_system/
‚îÇ   ‚îú‚îÄ‚îÄ features/                  # NEW module
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py            # NEW
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ embedding_service.py   # NEW: EmbeddingService class
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ embedding_cache.py     # NEW: EmbeddingCache class
‚îÇ   ‚îî‚îÄ‚îÄ config.py                  # MODIFIED: Add gemini_api_key property
‚îî‚îÄ‚îÄ tests/epic1/
    ‚îú‚îÄ‚îÄ test_embedding_service.py  # NEW: API integration tests
    ‚îî‚îÄ‚îÄ test_embedding_cache.py    # NEW: Cache tests
```

### Learnings from Previous Story

**From Story 1-3-ag-news-dataset-loading-and-validation (Status: review):**

- ‚úÖ **Data Module Pattern Established**: Follow same structure for features module
  - Create `src/context_aware_multi_agent_system/features/` directory
  - Add `__init__.py` with module exports
  - Import pattern: `from src.context_aware_multi_agent_system.features.embedding_service import EmbeddingService`

- ‚úÖ **Config Integration Pattern**: Use Config class for all parameters
  - Access embedding config: `config.get("embedding.model")` ‚Üí "gemini-embedding-001"
  - Access batch size: `config.get("embedding.batch_size")` ‚Üí 100
  - Access cache dir: `config.get("embedding.cache_dir")` ‚Üí "data/embeddings"
  - Add new property: `config.gemini_api_key` ‚Üí loads from environment

- ‚úÖ **Logging Pattern Established**: Follow emoji-prefixed logging from Story 1.3
  - INFO: "üìä Initializing Gemini API client..."
  - SUCCESS: "‚úÖ API authentication successful"
  - WARNING: "‚ö†Ô∏è API call failed, retrying (attempt 2/3)..."
  - ERROR: "‚ùå API authentication failed: Invalid API key"

- ‚úÖ **Type Hints Standard**: All methods have full type hints
  - Follow pattern from DatasetLoader class
  - Use typing module: `from typing import List, Dict, Tuple, Optional`
  - Example: `def generate_batch(self, documents: List[str], batch_size: int = 100) -> np.ndarray:`

- ‚úÖ **Error Handling Pattern**: Custom exceptions with informative messages
  - Create AuthenticationError similar to DatasetLoadError pattern
  - Include troubleshooting guidance: "Copy .env.example to .env and add your API key"
  - Raise with context: which operation failed, what to do next

- ‚úÖ **Validation Pattern**: Validate data integrity immediately
  - Validate embedding shape (768,) after API call
  - Validate dtype (float32) before saving
  - Log validation results for debugging

- ‚úÖ **Caching Pattern**: Similar to Hugging Face auto-caching
  - Check cache exists before API call
  - Load from cache if available (log: "‚ö†Ô∏è Using cached embeddings")
  - Generate and save to cache if missing
  - Store metadata alongside data for traceability

- ‚úÖ **Testing Infrastructure**: Follow Story 1.3 comprehensive test pattern
  - Create `tests/epic1/test_embedding_service.py` with multiple test classes
  - Map tests to acceptance criteria (AC-9, AC-10, AC-11, AC-12)
  - Use pytest.raises() for exception testing
  - Use pytest fixtures for test setup (temp config, mock API)

- ‚ö†Ô∏è **Module Structure**: Continue using `src/context_aware_multi_agent_system/` as root
  - Create `features/` submodule for embedding operations
  - Initialize with `__init__.py` exporting EmbeddingService and EmbeddingCache
  - Parallel structure to `data/` module from Story 1.3

**Files to Reuse (DO NOT RECREATE):**
- `src/context_aware_multi_agent_system/__init__.py` - Module root (existing)
- `src/context_aware_multi_agent_system/config.py` - Config and Paths classes (modify to add gemini_api_key property)
- `src/context_aware_multi_agent_system/utils/` - Utils package (existing)
- `src/context_aware_multi_agent_system/data/` - Data module from Story 1.3 (existing)
- `config.yaml` - Configuration file (existing, already has embedding section)
- `tests/epic1/__init__.py` - Test package initialization (existing)
- `.gitignore` - Git ignore file (verify includes .env)

**Key Services from Previous Stories:**
- **Config class** (Story 1.2): Use `config.get("embedding.model")` for Gemini model name
- **Paths class** (Story 1.2): Use `paths.data_embeddings` for cache directory
- **Logging utilities** (Story 1.2): Follow established emoji-prefixed pattern
- **DatasetLoader pattern** (Story 1.3): Use similar class structure and error handling

**Technical Debt to Address:**
- None from previous stories affecting this story
- Story 1.3 is in "review" status but fully functional and tested

**Review Findings from Story 1.3 to Apply:**
- ‚úÖ Use comprehensive docstrings with usage examples
- ‚úÖ Add type hints to all method signatures
- ‚úÖ Include explicit validation checks with informative error messages
- ‚úÖ Log all major operations for debugging
- ‚úÖ Write tests covering all acceptance criteria (100% coverage)
- ‚úÖ Document any deviations from specification with justification

[Source: stories/1-3-ag-news-dataset-loading-and-validation.md#Dev-Agent-Record]

### References

- [Source: docs/tech-spec-epic-1.md#AC-9 - Gemini API Authentication Successful]
- [Source: docs/tech-spec-epic-1.md#AC-10 - Gemini API Error Handling]
- [Source: docs/tech-spec-epic-1.md#AC-11 - Retry Logic Functional]
- [Source: docs/tech-spec-epic-1.md#AC-12 - Embedding Cache Functional]
- [Source: docs/tech-spec-epic-1.md#APIs and Interfaces - EmbeddingService API]
- [Source: docs/tech-spec-epic-1.md#APIs and Interfaces - EmbeddingCache API]
- [Source: docs/tech-spec-epic-1.md#Workflows and Sequencing - Story 1.4 Gemini API Integration Workflow]
- [Source: docs/PRD.md#FR-2 - Embedding Generation]
- [Source: docs/epics.md#Story 1.4 - Gemini API Integration and Authentication]
- [Source: docs/architecture.md#ADR-003 - Use Gemini Batch API]
- [Source: docs/architecture.md#Security Architecture - API Key Management]

## Dev Agent Record

### Context Reference

- `docs/stories/1-4-gemini-api-integration-and-authentication.context.xml` (Generated: 2025-11-09)

### Agent Model Used

{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

### File List
