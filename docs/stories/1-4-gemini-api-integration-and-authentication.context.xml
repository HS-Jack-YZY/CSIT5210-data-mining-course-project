<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>4</storyId>
    <title>Gemini API Integration and Authentication</title>
    <status>drafted</status>
    <generatedAt>2025-11-09</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/1-4-gemini-api-integration-and-authentication.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>data mining student</asA>
    <iWant>secure integration with Google Gemini Embedding API</iWant>
    <soThat>I can generate semantic embeddings for clustering</soThat>
    <tasks>
      <task id="1" ac="1,2,3">Implement EmbeddingService class with authentication, embedding generation, and retry logic</task>
      <task id="2" ac="4">Implement EmbeddingCache class for saving and loading embeddings</task>
      <task id="3" ac="2">Create custom exception classes (AuthenticationError, CacheNotFoundError)</task>
      <task id="4" ac="2">Create .env.example template file with API key placeholder</task>
      <task id="5" ac="1">Update Config class to provide gemini_api_key property</task>
      <task id="6" ac="1,2,3,4">Test Gemini API integration workflow (11 test scenarios)</task>
      <task id="7" ac="all">Update project documentation (README, usage examples, troubleshooting)</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1" title="Gemini API Authentication Successful">
      <given>Valid API key in .env</given>
      <when>I call EmbeddingService(api_key).test_connection()</when>
      <then>
        <check>Returns True (authentication successful)</check>
        <check>Test embedding generated for "Hello world"</check>
        <check>Embedding shape is (768,)</check>
        <check>Embedding dtype is float32</check>
        <check>Logs: "‚úÖ API authentication successful"</check>
      </then>
    </criterion>
    <criterion id="2" title="Gemini API Error Handling">
      <given>Invalid or missing API key</given>
      <when>I call EmbeddingService(api_key).test_connection()</when>
      <then>
        <check>Raises AuthenticationError with helpful message</check>
        <check>Error message includes: "GEMINI_API_KEY not found" or "Invalid API key"</check>
        <check>Error message includes next steps: "Copy .env.example to .env and add your API key"</check>
        <check>API key value never exposed in logs or error messages</check>
      </then>
    </criterion>
    <criterion id="3" title="Retry Logic Functional">
      <given>Network error occurs during API call</given>
      <when>Retry logic activates</when>
      <then>
        <check>Up to 3 retry attempts made</check>
        <check>Exponential backoff used: 4s, 8s, 16s (approximately)</check>
        <check>Each retry attempt logged: "‚ö†Ô∏è API call failed, retrying (attempt X/3)..."</check>
        <check>Success on retry logged: "‚úÖ API call successful after X attempts"</check>
        <check>Failure after 3 attempts raises exception with context</check>
      </then>
    </criterion>
    <criterion id="4" title="Embedding Cache Functional">
      <given>Embeddings generated</given>
      <when>I call EmbeddingCache().save(embeddings, "train", metadata)</when>
      <then>
        <check>Embeddings saved to data/embeddings/train_embeddings.npy</check>
        <check>Metadata saved to data/embeddings/train_metadata.json</check>
        <check>Saved embeddings are float32 dtype</check>
        <check>Metadata includes: model, dimensions, num_documents, timestamp, dataset, split, api_calls, estimated_cost</check>
      </then>
      <and>
        <when>I call EmbeddingCache().load("train")</when>
        <then>
          <check>Returns tuple of (embeddings, metadata)</check>
          <check>Loaded embeddings match original (np.allclose check)</check>
          <check>Loaded metadata matches saved metadata</check>
        </then>
      </and>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <artifact>
        <path>docs/tech-spec-epic-1.md</path>
        <title>Technical Specification - Epic 1</title>
        <section>Acceptance Criteria (AC-9 to AC-12)</section>
        <snippet>Defines Gemini API Authentication Successful, Error Handling, Retry Logic Functional, and Embedding Cache Functional acceptance criteria with specific validation requirements.</snippet>
      </artifact>
      <artifact>
        <path>docs/tech-spec-epic-1.md</path>
        <title>Technical Specification - Epic 1</title>
        <section>APIs and Interfaces - EmbeddingService API</section>
        <snippet>Specifies EmbeddingService interface with authentication, batch processing, retry logic. Uses google-genai SDK with gemini-embedding-001 model (768 dimensions).</snippet>
      </artifact>
      <artifact>
        <path>docs/tech-spec-epic-1.md</path>
        <title>Technical Specification - Epic 1</title>
        <section>APIs and Interfaces - EmbeddingCache API</section>
        <snippet>Defines cache management for embeddings with save/load operations to data/embeddings directory using .npy format for arrays and .json for metadata.</snippet>
      </artifact>
      <artifact>
        <path>docs/tech-spec-epic-1.md</path>
        <title>Technical Specification - Epic 1</title>
        <section>Configuration Schema</section>
        <snippet>Embedding configuration: model="gemini-embedding-001", batch_size=100, cache_dir="data/embeddings". Environment variables include GEMINI_API_KEY.</snippet>
      </artifact>
      <artifact>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>ADR-003 - Use Gemini Batch API</section>
        <snippet>Decision to use Gemini Batch API for 50% cost savings ($0.075/M tokens vs $0.15/M). Provides 768-dimensional embeddings with batch processing support.</snippet>
      </artifact>
      <artifact>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>Security Architecture - API Key Management</section>
        <snippet>API keys stored in .env file (NOT committed to git). Uses python-dotenv for secure loading. .gitignore prevents secret leaks.</snippet>
      </artifact>
      <artifact>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>FR-2 - Embedding Generation</section>
        <snippet>System must interface with Google Gemini Embedding API for semantic vector generation. Support batch processing and real-time embedding for query classification.</snippet>
      </artifact>
      <artifact>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Epic 1 - Data Preparation & Embedding Generation</section>
        <snippet>Generate embeddings for all documents using Google Gemini Embedding API. Use Batch API for cost efficiency. Store embeddings for clustering phase.</snippet>
      </artifact>
    </docs>
    <code>
      <artifact>
        <path>src/context_aware_multi_agent_system/config.py</path>
        <kind>configuration</kind>
        <symbol>Config</symbol>
        <lines>19-202</lines>
        <reason>Existing Config class with gemini_api_key property (lines 158-176). Story must extend this class, NOT recreate it. Provides get() method for accessing config values and validate() for validation.</reason>
      </artifact>
      <artifact>
        <path>src/context_aware_multi_agent_system/config.py</path>
        <kind>configuration</kind>
        <symbol>Paths</symbol>
        <lines>204-277</lines>
        <reason>Existing Paths class with data_embeddings property for cache directory management. Story must use paths.data_embeddings, NOT hardcode paths.</reason>
      </artifact>
      <artifact>
        <path>src/context_aware_multi_agent_system/data/load_dataset.py</path>
        <kind>service</kind>
        <symbol>DatasetLoadError</symbol>
        <lines>24-35</lines>
        <reason>Pattern for custom exception classes established in Story 1.3. Follow same structure for AuthenticationError and CacheNotFoundError.</reason>
      </artifact>
      <artifact>
        <path>src/context_aware_multi_agent_system/data/load_dataset.py</path>
        <kind>service</kind>
        <symbol>DatasetLoader</symbol>
        <lines>38-50</lines>
        <reason>Pattern for service class structure with config integration and logging. EmbeddingService should follow similar initialization and method structure.</reason>
      </artifact>
      <artifact>
        <path>src/context_aware_multi_agent_system/features/__init__.py</path>
        <kind>module</kind>
        <symbol>features</symbol>
        <lines>1-1</lines>
        <reason>Features module already exists. Story will add embedding_service.py and embedding_cache.py to this module.</reason>
      </artifact>
    </code>
    <dependencies>
      <python>
        <package name="google-genai" version=">=0.3.0" purpose="Gemini API SDK for embedding generation" />
        <package name="numpy" version=">=1.24.0" purpose="Embedding array storage and operations" />
        <package name="tenacity" version=">=8.0.0" purpose="Retry decorator for API resilience" />
        <package name="python-dotenv" version=">=1.0.0" purpose="Environment variable management (.env loading)" />
        <package name="PyYAML" version=">=6.0" purpose="Configuration file loading (config.yaml)" />
        <package name="pytest" version=">=7.4.0" purpose="Testing framework" />
      </python>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>MUST NOT recreate Config or Paths classes - they already exist in src/context_aware_multi_agent_system/config.py</constraint>
    <constraint>MUST use config.get("embedding.model") to access configuration values, NOT hardcoded strings</constraint>
    <constraint>MUST use paths.data_embeddings for cache directory, NOT hardcoded paths</constraint>
    <constraint>MUST follow emoji-prefixed logging pattern established in Stories 1.2 and 1.3 (üìä INFO, ‚úÖ SUCCESS, ‚ö†Ô∏è WARNING, ‚ùå ERROR)</constraint>
    <constraint>MUST use type hints for all methods and function signatures (established pattern from Story 1.3)</constraint>
    <constraint>MUST include comprehensive docstrings with usage examples in Google style (established pattern from Story 1.3)</constraint>
    <constraint>MUST create custom exceptions (AuthenticationError, CacheNotFoundError) following DatasetLoadError pattern from Story 1.3</constraint>
    <constraint>MUST use tenacity library for retry logic with exponential backoff (max 3 attempts, 4s/8s/16s backoff)</constraint>
    <constraint>MUST validate all embedding shapes (768,) and dtype (float32) before returning or saving</constraint>
    <constraint>MUST mask API key in all logs and error messages (show as GEMINI_API_KEY=***)</constraint>
    <constraint>MUST save embeddings as .npy files and metadata as .json files in data/embeddings/ directory</constraint>
    <constraint>MUST use the NEW Gemini API import: "from google import genai" NOT "import google.generativeai"</constraint>
    <constraint>Tests MUST be created in tests/epic1/ directory following Story 1.3 structure</constraint>
    <constraint>Tests MUST cover all 4 acceptance criteria with at least 11 test scenarios as specified</constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>EmbeddingService.__init__</name>
      <kind>class-method</kind>
      <signature>def __init__(self, api_key: str, model: str = "gemini-embedding-001") -> None</signature>
      <path>src/context_aware_multi_agent_system/features/embedding_service.py</path>
    </interface>
    <interface>
      <name>EmbeddingService.test_connection</name>
      <kind>class-method</kind>
      <signature>def test_connection(self) -> bool</signature>
      <path>src/context_aware_multi_agent_system/features/embedding_service.py</path>
    </interface>
    <interface>
      <name>EmbeddingService.generate_embedding</name>
      <kind>class-method</kind>
      <signature>def generate_embedding(self, text: str) -> np.ndarray</signature>
      <path>src/context_aware_multi_agent_system/features/embedding_service.py</path>
    </interface>
    <interface>
      <name>EmbeddingService.generate_batch</name>
      <kind>class-method</kind>
      <signature>def generate_batch(self, documents: List[str], batch_size: int = 100) -> np.ndarray</signature>
      <path>src/context_aware_multi_agent_system/features/embedding_service.py</path>
    </interface>
    <interface>
      <name>EmbeddingCache.__init__</name>
      <kind>class-method</kind>
      <signature>def __init__(self, cache_dir: Path) -> None</signature>
      <path>src/context_aware_multi_agent_system/features/embedding_cache.py</path>
    </interface>
    <interface>
      <name>EmbeddingCache.save</name>
      <kind>class-method</kind>
      <signature>def save(self, embeddings: np.ndarray, split: str, metadata: Dict[str, Any]) -> Path</signature>
      <path>src/context_aware_multi_agent_system/features/embedding_cache.py</path>
    </interface>
    <interface>
      <name>EmbeddingCache.load</name>
      <kind>class-method</kind>
      <signature>def load(self, split: str) -> Tuple[np.ndarray, Dict[str, Any]]</signature>
      <path>src/context_aware_multi_agent_system/features/embedding_cache.py</path>
    </interface>
    <interface>
      <name>EmbeddingCache.exists</name>
      <kind>class-method</kind>
      <signature>def exists(self, split: str) -> bool</signature>
      <path>src/context_aware_multi_agent_system/features/embedding_cache.py</path>
    </interface>
    <interface>
      <name>Config.gemini_api_key</name>
      <kind>property</kind>
      <signature>@property gemini_api_key(self) -> str</signature>
      <path>src/context_aware_multi_agent_system/config.py</path>
    </interface>
  </interfaces>
  <tests>
    <standards>
      Testing framework: pytest (>=7.4.0). All tests must be created in tests/epic1/ directory following Story 1.3 structure.
      Tests must map to acceptance criteria IDs (AC-1, AC-2, AC-3, AC-4). Use pytest.raises() for exception testing.
      Use pytest fixtures for test setup (temp config, mock API). Follow comprehensive test pattern from Story 1.3 with
      multiple test classes organizing related scenarios. Mock external API calls using unittest.mock.patch to avoid
      real API usage during tests. Validate all embedding shapes (768,) and dtype (float32). Test retry logic with
      mock network failures. Test cache roundtrip (save then load, verify match with np.allclose).
    </standards>
    <locations>
      <location>tests/epic1/test_embedding_service.py</location>
      <location>tests/epic1/test_embedding_cache.py</location>
    </locations>
    <ideas>
      <idea ac="1">Test EmbeddingService authentication with valid API key - verify test_connection() returns True and test embedding shape/dtype</idea>
      <idea ac="2">Test EmbeddingService authentication failure with missing API key - verify raises AuthenticationError with helpful message</idea>
      <idea ac="2">Test EmbeddingService authentication failure with invalid API key - verify raises AuthenticationError and API key is masked in logs</idea>
      <idea ac="1">Test single embedding generation - verify shape (768,) and dtype float32</idea>
      <idea ac="1">Test batch embedding generation with 100 documents - verify shape (100, 768) and dtype float32</idea>
      <idea ac="3">Test retry logic with mock network failures - verify 3 attempts, exponential backoff timing, retry logs</idea>
      <idea ac="3">Test successful retry after failures - verify success log includes attempt count</idea>
      <idea ac="4">Test EmbeddingCache save operation - verify .npy and .json files created in data/embeddings/</idea>
      <idea ac="4">Test EmbeddingCache load operation - verify returns tuple of (embeddings, metadata)</idea>
      <idea ac="4">Test cache roundtrip - save embeddings, load them back, verify np.allclose match</idea>
      <idea ac="4">Test cache exists() method - verify returns True when cache files exist, False otherwise</idea>
      <idea ac="2">Test Config.gemini_api_key property raises ValueError when GEMINI_API_KEY not in environment</idea>
    </ideas>
  </tests>
</story-context>
